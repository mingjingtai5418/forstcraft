name: Deploy VitePress to Baota

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯

jobs:
  deploy:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–° Ubuntu ç¯å¢ƒ
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
      
      # æ­¥éª¤2: è®¾ç½® Node.js 20 LTSï¼ˆå…³é”®æ­¥éª¤ï¼‰
      - name: Setup Node.js 20 LTS
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ä½¿ç”¨ Node.js 20 LTS ç‰ˆæœ¬
          cache: 'npm'  # ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
          cache-dependency-path: '**/package-lock.json'  # å¦‚æœæœ‰ package-lock.json
      
      # æ­¥éª¤3: éªŒè¯ç¯å¢ƒï¼ˆè°ƒè¯•ç”¨ï¼‰
      - name: Debug environment
        run: |
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          
          # æ£€æŸ¥ crypto æ”¯æŒ
          node -e "
            console.log('=== Crypto æ”¯æŒæ£€æŸ¥ ===');
            console.log('globalThis.crypto å­˜åœ¨:', 'crypto' in globalThis);
            console.log('global.crypto å­˜åœ¨:', 'crypto' in global);
            if ('crypto' in globalThis) {
              console.log('crypto.getRandomValues ç±»å‹:', typeof globalThis.crypto.getRandomValues);
            }
          "
      
      # æ­¥éª¤4: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          echo "=== å®‰è£…ä¾èµ– ==="
          
          # æ¸…ç†å¯èƒ½çš„ç¼“å­˜
          npm cache clean --force || true
          
          # ä½¿ç”¨ npm ci ç¡®ä¿ä¾èµ–ä¸€è‡´æ€§ï¼ˆå¦‚æœæœ‰ package-lock.jsonï¼‰
          if [ -f "package-lock.json" ]; then
            echo "ä½¿ç”¨ npm ci å®‰è£…ä¾èµ–..."
            npm ci --no-audit --prefer-offline
          else
            echo "ä½¿ç”¨ npm install å®‰è£…ä¾èµ–..."
            npm install --no-audit
          fi
          
          echo "ä¾èµ–å®‰è£…å®Œæˆ"
      
      # æ­¥éª¤5: ä¿®å¤ crypto é—®é¢˜ï¼ˆé¢„é˜²æ€§æªæ–½ï¼‰
      - name: Fix crypto compatibility
        run: |
          echo "=== ä¿®å¤ crypto å…¼å®¹æ€§ ==="
          
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ä¿®å¤æ–‡ä»¶
          cat > crypto-polyfill.js << 'EOF'
          // ä¸º GitHub Actions ç¯å¢ƒæä¾› crypto polyfill
          const crypto = require('crypto');
          
          if (!globalThis.crypto) {
            console.log('æ³¨å…¥ crypto polyfill...');
            
            if (crypto.webcrypto) {
              // å¦‚æœ Node.js æœ‰ webcrypto API
              globalThis.crypto = crypto.webcrypto;
            } else {
              // ç®€å•çš„ polyfill
              globalThis.crypto = {
                getRandomValues: function(buffer) {
                  return crypto.randomFillSync(buffer);
                },
                randomUUID: function() {
                  return crypto.randomBytes(16).toString('hex');
                },
                subtle: {}
              };
            }
            console.log('crypto polyfill æ³¨å…¥æˆåŠŸ');
          } else {
            console.log('crypto å·²å­˜åœ¨ï¼Œæ— éœ€æ³¨å…¥');
          }
          
          // å¯¼å‡ºç»™å…¶ä»–æ¨¡å—ä½¿ç”¨
          module.exports = globalThis.crypto;
          EOF
          
          echo "crypto ä¿®å¤è„šæœ¬åˆ›å»ºå®Œæˆ"
      
      # æ­¥éª¤6: æ„å»º VitePress é¡¹ç›®
      - name: Build VitePress
        run: |
          echo "=== å¼€å§‹æ„å»º VitePress ==="
          
          # å…ˆé¢„åŠ è½½ crypto ä¿®å¤
          export NODE_OPTIONS="--require ./crypto-polyfill.js"
          
          # æ‰§è¡Œæ„å»ºå‘½ä»¤
          echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: npm run docs:build"
          npm run docs:build
          
          echo "âœ… æ„å»ºå®Œæˆ"
        env:
          NODE_OPTIONS: "--require ./crypto-polyfill.js"  # ç¡®ä¿ crypto ä¿®å¤ç”Ÿæ•ˆ
          NODE_ENV: "production"  # è®¾ç½®ä¸ºç”Ÿäº§ç¯å¢ƒ
      
      # æ­¥éª¤7: éªŒè¯æ„å»ºç»“æœ
      - name: Verify build output
        run: |
          echo "=== éªŒè¯æ„å»ºç»“æœ ==="
          
          # æ£€æŸ¥æ„å»ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "docs/.vitepress/dist" ]; then
            echo "âœ… æ„å»ºç›®å½•å­˜åœ¨: docs/.vitepress/dist"
            echo "æ–‡ä»¶åˆ—è¡¨:"
            ls -la docs/.vitepress/dist/
            echo "HTML æ–‡ä»¶:"
            find docs/.vitepress/dist -name "*.html" | head -5
          else
            echo "âŒ é”™è¯¯: æ„å»ºç›®å½•ä¸å­˜åœ¨"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            echo "docs ç›®å½•å†…å®¹:"
            ls -la docs/ || echo "æ²¡æœ‰ docs ç›®å½•"
            exit 1  # å¤±è´¥é€€å‡º
          fi
      
      # æ­¥éª¤8: é…ç½® SSH éƒ¨ç½²
      - name: Setup SSH for deployment
        run: |
          echo "=== é…ç½® SSH ==="
          
          mkdir -p ~/.ssh
          # ä» GitHub Secrets è¯»å–ç§é’¥
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "ç§é’¥å·²ä¿å­˜ï¼Œæƒé™å·²è®¾ç½®"
          
          # éªŒè¯ç§é’¥æ ¼å¼
          echo "éªŒè¯ç§é’¥æ ¼å¼..."
          ssh-keygen -l -f ~/.ssh/id_rsa 2>/dev/null && echo "âœ… ç§é’¥æ ¼å¼æ­£ç¡®" || echo "âš ï¸  ç§é’¥æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          
          # æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
          echo "æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts..."
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "âœ… SSH é…ç½®å®Œæˆ"
      
      # æ­¥éª¤9: æµ‹è¯• SSH è¿æ¥
      - name: Test SSH connection
        run: |
          echo "=== æµ‹è¯• SSH è¿æ¥ ==="
          
          ssh -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              -i ~/.ssh/id_rsa \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "echo 'âœ… SSH è¿æ¥æˆåŠŸï¼æœåŠ¡å™¨æ—¶é—´: $(date)'" || {
            echo "âŒ SSH è¿æ¥å¤±è´¥"
            exit 1
          }
      
      # æ­¥éª¤10: éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨
      - name: Deploy to Baota Server
        run: |
          echo "=== å¼€å§‹éƒ¨ç½² ==="
          
          # å®‰è£… rsyncï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
          echo "æ£€æŸ¥ rsync..."
          if ! command -v rsync &> /dev/null; then
            echo "å®‰è£… rsync..."
            sudo apt-get update && sudo apt-get install -y rsync
          fi
          
          echo "æºç›®å½•: docs/.vitepress/dist/"
          echo "ç›®æ ‡: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}"
          
          # ä½¿ç”¨ rsync åŒæ­¥æ–‡ä»¶
          rsync -avz \
            --delete \
            --progress \
            --exclude=".*" \
            -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
            docs/.vitepress/dist/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.TARGET_PATH }}
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
      
      # æ­¥éª¤11: è®¾ç½®å®å¡”æœåŠ¡å™¨æƒé™
      - name: Set Baota permissions
        run: |
          echo "=== è®¾ç½®æœåŠ¡å™¨æƒé™ ==="
          
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/id_rsa \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "chown -R www:www ${{ secrets.TARGET_PATH }} && \
               chmod -R 755 ${{ secrets.TARGET_PATH }} && \
               echo 'âœ… æƒé™è®¾ç½®å®Œæˆ: $(ls -ld ${{ secrets.TARGET_PATH }})'"
      
      # æ­¥éª¤12: éªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify deployment
        run: |
          echo "=== éªŒè¯éƒ¨ç½²ç»“æœ ==="
          
          ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/id_rsa \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
              "echo 'éƒ¨ç½²éªŒè¯:' && \
               echo 'ç›®å½•: ${{ secrets.TARGET_PATH }}' && \
               echo 'æ‰€æœ‰è€…:' && ls -ld ${{ secrets.TARGET_PATH }} && \
               echo 'æ–‡ä»¶æ•°é‡:' && find ${{ secrets.TARGET_PATH }} -type f | wc -l && \
               echo 'å‰10ä¸ªæ–‡ä»¶:' && ls -la ${{ secrets.TARGET_PATH }} | head -15"
          
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å…¨éƒ¨å®Œæˆï¼"