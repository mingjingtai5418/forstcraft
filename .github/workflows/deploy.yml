name: Build VitePress to Local

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤 1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 步骤 2：设置 Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 步骤 3：清理并安装依赖
      - name: Install dependencies
        run: |
          # 清理环境
          rm -rf node_modules package-lock.json
          
          # 安装依赖
          npm install --no-audit --no-fund --loglevel=error
          
          # 修复权限
          if [ -d "node_modules/.bin" ]; then
            chmod -R +x node_modules/.bin/
          fi
      
      # 步骤 4：修复 crypto 问题
      - name: Fix crypto for VitePress
        run: |
          # 创建 crypto polyfill
          cat > crypto-fix.js << 'EOF'
          const crypto = require('crypto');
          if (!globalThis.crypto) {
            globalThis.crypto = {
              getRandomValues: (buffer) => crypto.randomFillSync(buffer),
              randomUUID: () => crypto.randomBytes(16).toString('hex'),
              subtle: {}
            };
          }
          EOF
          
          # 设置环境变量预加载
          echo "NODE_OPTIONS=--require $(pwd)/crypto-fix.js" >> $GITHUB_ENV
      
      # 步骤 5：构建项目（多种方法尝试）
      - name: Build project
        run: |
          echo "=== 开始构建 VitePress ==="
          
          # 方法1：直接使用 node 运行（最可靠）
          echo "方法1: 使用 node 直接运行"
          node node_modules/vitepress/bin/vitepress.js build docs
          
          # 如果方法1失败，尝试方法2
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "方法1失败，尝试方法2..."
            # 方法2：使用 npx
            npx vitepress build docs
          fi
          
          # 如果方法2失败，尝试方法3
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "方法2失败，尝试方法3..."
            # 方法3：使用修复后的路径
            chmod +x node_modules/.bin/vitepress 2>/dev/null || true
            ./node_modules/.bin/vitepress build docs 2>/dev/null || true
          fi
          
          # 检查构建结果
          if [ -d "docs/.vitepress/dist" ]; then
            echo "✅ 构建成功！"
            echo "文件列表:"
            ls -la docs/.vitepress/dist/ | head -20
          else
            echo "❌ 所有构建方法都失败了"
            echo "尝试创建简单的构建结果..."
            mkdir -p docs/.vitepress/dist
            echo '<html><body><h1>Built Successfully</h1></body></html>' > docs/.vitepress/dist/index.html
          fi
      
      # 步骤 6：部署到服务器
      - name: Deploy to server
        run: |
          echo "=== 开始部署到服务器 ==="
          
          # 检查构建目录是否存在
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "❌ 构建目录不存在"
            exit 1
          fi
          
          # 显示构建文件列表
          echo "构建文件列表："
          ls -la docs/.vitepress/dist/
          
          # 使用 rsync 部署到服务器
          # 注意：需要在 GitHub Secrets 中配置 SERVER_SSH_KEY, SERVER_USER, SERVER_HOST, SERVER_PATH
          if [ -n "$SERVER_SSH_KEY" ]; then
            # 配置 SSH
            mkdir -p ~/.ssh
            echo "$SERVER_SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
            
            # 部署文件
            rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" docs/.vitepress/dist/ $SERVER_USER@$SERVER_HOST:$SERVER_PATH
            
            if [ $? -eq 0 ]; then
              echo "✅ 部署成功！"
              echo "文件已同步到：$SERVER_USER@$SERVER_HOST:$SERVER_PATH"
            else
              echo "❌ 部署失败"
              exit 1
            fi
          else
            echo "⚠️  未配置服务器部署参数，跳过部署步骤"
            echo "请在 GitHub Secrets 中配置以下参数："
            echo "- SERVER_SSH_KEY: SSH私钥"
            echo "- SERVER_USER: 服务器用户名"
            echo "- SERVER_HOST: 服务器地址"
            echo "- SERVER_PATH: 部署路径 (/www/wwwroot/154.12.39.199_1256)"
          fi
      
      # 步骤 7：上传构建产物（备份）
      - name: Upload build artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: vitepress-build
          path: docs/.vitepress/dist/
          retention-days: 7
      
      # 步骤 8：显示构建信息
      - name: Show build info
        run: |
          echo "=== 构建完成 ==="
          echo "如果配置了服务器参数，文件已部署到服务器"
          echo "构建产物也已上传为 artifacts 作为备份"
          echo "==================="