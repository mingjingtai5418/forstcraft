name: Deploy VitePress to Baota

on:
  push:
    branches: [ "main" ]  # åªåœ¨ main åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  # å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œ
  # workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # ä½¿ç”¨ç­–ç•¥çŸ©é˜µæµ‹è¯•ä¸åŒ Node.js ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
    strategy:
      matrix:
        node-version: [20.x]  # å»ºè®®ä½¿ç”¨ 20.xï¼Œä¿®å¤ crypto é—®é¢˜
    
    steps:
    # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # æ­¥éª¤ 2ï¼šè®¾ç½® Node.js ç¯å¢ƒï¼ˆä½¿ç”¨ç­–ç•¥çŸ©é˜µä¸­çš„ç‰ˆæœ¬ï¼‰
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    # æ­¥éª¤ 3ï¼šç¯å¢ƒè¯Šæ–­ï¼ˆè°ƒè¯•ç”¨ï¼‰
    - name: Environment diagnostics
      run: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        echo "Node.js ç‰ˆæœ¬: $(node --version)"
        echo "npm ç‰ˆæœ¬: $(npm --version)"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "docs ç›®å½•å†…å®¹:"
        ls -la docs/ || echo "æ—  docs ç›®å½•"
        
        # æ£€æŸ¥ crypto æ”¯æŒ
        echo "=== Crypto æ”¯æŒæ£€æŸ¥ ==="
        node -e "
          console.log('globalThis.crypto exists:', 'crypto' in globalThis);
          if ('crypto' in globalThis) {
            console.log('crypto type:', typeof globalThis.crypto);
            console.log('getRandomValues exists:', 'getRandomValues' in globalThis.crypto);
          }
          try {
            const crypto = require('crypto');
            console.log('Node.js crypto module loaded successfully');
            console.log('has webcrypto:', !!crypto.webcrypto);
          } catch (e) {
            console.log('Failed to load crypto module:', e.message);
          }
        "
    
    # æ­¥éª¤ 4ï¼šä¿®å¤ crypto é—®é¢˜ï¼ˆå…³é”®æ­¥éª¤ï¼‰
    - name: Fix crypto compatibility
      run: |
        echo "=== ä¿®å¤ crypto å…¼å®¹æ€§ ==="
        
        # æ–¹æ³• 1ï¼šåˆ›å»º crypto polyfill
        cat > .crypto-polyfill.js << 'EOF'
        // GitHub Actions VitePress Crypto Polyfill
        const nodeCrypto = require('crypto');
        
        if (!globalThis.crypto) {
          console.log('[Polyfill] Injecting crypto polyfill...');
          
          // å°è¯•ä½¿ç”¨ Node.js 18+ çš„ webcrypto
          if (nodeCrypto.webcrypto) {
            globalThis.crypto = nodeCrypto.webcrypto;
            console.log('[Polyfill] Using Node.js webcrypto API');
          }
          // å¤‡é€‰æ–¹æ¡ˆï¼šåˆ›å»ºç®€å• polyfill
          else {
            globalThis.crypto = {
              getRandomValues: function(buffer) {
                return nodeCrypto.randomFillSync(buffer);
              },
              randomUUID: function() {
                return nodeCrypto.randomBytes(16).toString('hex');
              },
              subtle: {}
            };
            console.log('[Polyfill] Using custom polyfill');
          }
        } else {
          console.log('[Polyfill] crypto already exists in globalThis');
        }
        
        // ç¡®ä¿ process.nextTick å­˜åœ¨ï¼ˆæŸäº›ç¯å¢ƒä¸‹å¯èƒ½æ²¡æœ‰ï¼‰
        if (typeof process === 'undefined') {
          global.process = { nextTick: (fn) => setTimeout(fn, 0) };
        }
        
        module.exports = globalThis.crypto;
        EOF
        
        echo "Crypto polyfill created"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®© Node.js é¢„åŠ è½½è¿™ä¸ª polyfill
        echo "NODE_OPTIONS=--require $(pwd)/.crypto-polyfill.js" >> $GITHUB_ENV
    
    # æ­¥éª¤ 5ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        echo "=== å®‰è£…ä¾èµ– ==="
        
        # æ¸…ç† npm ç¼“å­˜
        npm cache clean --force || true
        
        # æ ¹æ®æ˜¯å¦æœ‰ package-lock.json é€‰æ‹©å®‰è£…æ–¹å¼
        if [ -f "package-lock.json" ]; then
          echo "ä½¿ç”¨ npm ci å®‰è£…ï¼ˆæ¨èï¼‰"
          npm ci --no-audit --prefer-offline
        else
          echo "ä½¿ç”¨ npm install å®‰è£…"
          npm install --no-audit
        fi
        
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
    
    # æ­¥éª¤ 6ï¼šæ„å»º VitePress
    - name: Build VitePress
      run: |
        echo "=== å¼€å§‹æ„å»º VitePress ==="
        
        # æ˜¾ç¤ºæ„å»ºå‘½ä»¤
        echo "æ„å»ºå‘½ä»¤: npm run docs:build"
        echo "å½“å‰ç¯å¢ƒå˜é‡ NODE_OPTIONS: $NODE_OPTIONS"
        
        # æ‰§è¡Œæ„å»º
        npm run docs:build
        
        echo "âœ… æ„å»ºå®Œæˆ"
    
    # æ­¥éª¤ 7ï¼šéªŒè¯æ„å»ºç»“æœ
    - name: Verify build output
      run: |
        echo "=== éªŒè¯æ„å»ºç»“æœ ==="
        
        # æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•
        BUILD_DIR="docs/.vitepress/dist"
        
        if [ -d "$BUILD_DIR" ]; then
          echo "âœ… æ„å»ºæˆåŠŸï¼è¾“å‡ºç›®å½•: $BUILD_DIR"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la "$BUILD_DIR"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ HTML æ–‡ä»¶
          HTML_COUNT=$(find "$BUILD_DIR" -name "*.html" | wc -l)
          echo "HTML æ–‡ä»¶æ•°é‡: $HTML_COUNT"
          
          if [ $HTML_COUNT -eq 0 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ° HTML æ–‡ä»¶"
          fi
        else
          echo "âŒ é”™è¯¯ï¼šæ„å»ºç›®å½•ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•ç»“æ„:"
          find . -type d -name "vitepress*" -o -name "dist" | head -20
          exit 1
        fi
    
    # æ­¥éª¤ 8ï¼šé…ç½® SSHï¼ˆéƒ¨ç½²åˆ°å®å¡”ï¼‰
    - name: Setup SSH for deployment
      if: github.ref == 'refs/heads/main'  # åªåœ¨ main åˆ†æ”¯éƒ¨ç½²
      run: |
        echo "=== é…ç½® SSH è¿æ¥ ==="
        
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # éªŒè¯ç§é’¥
        ssh-keygen -l -f ~/.ssh/id_rsa 2>/dev/null || echo "ç§é’¥æ ¼å¼æ£€æŸ¥è·³è¿‡"
        
        # æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        
        echo "SSH é…ç½®å®Œæˆ"
    
    # æ­¥éª¤ 9ï¼šéƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨
    - name: Deploy to Baota Server
      if: github.ref == 'refs/heads/main'  # åªåœ¨ main åˆ†æ”¯éƒ¨ç½²
      run: |
        echo "=== éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨ ==="
        
        # æ£€æŸ¥å¿…è¦çš„ secrets
        if [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "âŒ é”™è¯¯ï¼šSERVER_HOST æœªè®¾ç½®"
          exit 1
        fi
        
        echo "æœåŠ¡å™¨: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
        echo "ç›®æ ‡ç›®å½•: ${{ secrets.TARGET_PATH }}"
        echo "æºç›®å½•: docs/.vitepress/dist/"
        
        # å®‰è£… rsyncï¼ˆå¦‚æœéœ€è¦ï¼‰
        if ! command -v rsync &> /dev/null; then
          echo "å®‰è£… rsync..."
          sudo apt-get update && sudo apt-get install -y rsync
        fi
        
        # ä½¿ç”¨ rsync éƒ¨ç½²
        rsync -avz \
          --delete \
          --progress \
          --chmod=755 \
          -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
          docs/.vitepress/dist/ \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:"${{ secrets.TARGET_PATH }}"
        
        echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
    
    # æ­¥éª¤ 10ï¼šè®¾ç½®æœåŠ¡å™¨æƒé™ï¼ˆå®å¡”ä¸“ç”¨ï¼‰
    - name: Set Baota permissions
      if: github.ref == 'refs/heads/main'
      run: |
        echo "=== è®¾ç½®å®å¡”æƒé™ ==="
        
        ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "chown -R www:www '${{ secrets.TARGET_PATH }}' && \
             chmod -R 755 '${{ secrets.TARGET_PATH }}' && \
             echo 'âœ… æƒé™è®¾ç½®å®Œæˆ'"
    
    # æ­¥éª¤ 11ï¼šéƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    - name: Deployment success
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "æ—¶é—´: $(date)"
        
        # æµ‹è¯•ç½‘ç«™æ˜¯å¦å¯è®¿é—®ï¼ˆå¯é€‰ï¼‰
        echo "=== éƒ¨ç½²éªŒè¯ ==="
        ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/id_rsa \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "echo 'æœ€åæ›´æ–°:' && date && echo 'ç›®å½•å¤§å°:' && du -sh '${{ secrets.TARGET_PATH }}'"